def add_biplot_arrows_at_anchor_3d(
    fig: go.Figure,
    pca,
    feature_names: list[str],
    anchor: np.ndarray,
    *,
    scale: float = 1.5,
    color: str | None = None,
    name_prefix: str = "",
    showlegend: bool = False,
):
    """
    Draw PCA loading arrows but *anchored* at a specified 3D point (anchor),
    using the same global PCA directions (first 2–3 PCs).
    This visually associates feature directions with a local cluster.

    Parameters
    ----------
    fig : plotly.graph_objects.Figure
        Target figure (3D scatter) to overlay arrows into.
    pca : fitted sklearn.decomposition.PCA
        The global PCA used for visualization.
    feature_names : list[str]
        Names of features corresponding to the PCA fit order.
    anchor : np.ndarray
        3D point (PC1, PC2, PC3) to anchor the arrows from (e.g., a cluster centroid).
    scale : float
        Arrow length multiplier in PC units.
    color : Optional[str]
        Line/text color for the arrows (e.g., 'green', 'red').
    name_prefix : str
        Prefix for trace names (e.g., 'Low FR', 'High FR').
    showlegend : bool
        Whether to show a legend entry for each arrow line (usually False to avoid clutter).
    """
    loadings = getattr(pca, "components_", None)
    if loadings is None:
        return fig
    loadings = loadings.T  # shape: (n_features, n_components)
    k = min(3, loadings.shape[1])
    if k < 2:
        return fig

    ax, ay, az = (anchor[0], anchor[1], anchor[2]) if len(anchor) >= 3 else (anchor[0], anchor[1], 0.0)

    for i, fname in enumerate(feature_names):
        vec = loadings[i, :k] * scale
        if k >= 3:
            x = [ax, ax + float(vec[0])]
            y = [ay, ay + float(vec[1])]
            z = [az, az + float(vec[2])]
            fig.add_trace(
                go.Scatter3d(
                    x=x, y=y, z=z, mode="lines",
                    line=dict(width=4, color=color) if color else dict(width=4),
                    name=f"{name_prefix}→ {fname}",
                    showlegend=showlegend,
                )
            )
            # Text label at arrow tip
            fig.add_trace(
                go.Scatter3d(
                    x=[x[-1]], y=[y[-1]], z=[z[-1]],
                    mode="text",
                    text=[fname],
                    textposition="top center",
                    showlegend=False
                )
            )
        else:
            # 2D fallback
            x = [ax, ax + float(vec[0])]
            y = [ay, ay + float(vec[1])]
            fig.add_trace(
                go.Scatter(
                    x=x, y=y, mode="lines+text",
                    text=[None, f"{name_prefix}→ {fname}"],
                    textposition="top center",
                    line=dict(width=4, color=color) if color else dict(width=4),
                    showlegend=showlegend
                )
            )
    return fig




=========================================================================================================================================================================
=========================================================================================================================================================================

def _render_table_and_plot(
    df: pd.DataFrame,
    PCs: np.ndarray,
    scores01: np.ndarray,
    raw_scores: np.ndarray,
    method_label: str,
    key_prefix: str,
    pca,  # global PCA (for loadings)
):
    """
    Renders:
      1) Top anomalies table with row selection
      2) PCA scatter with optional highlight + PCA loading arrows (global + segment-anchored)
      3) Segment Comparison & FR correlation panels (optional)
      4) Per-selection 'Why this run?' panel (optional)
    """
    df = df.copy()
    df["anomaly_score"] = scores01
    df["raw_anomaly_score"] = raw_scores

    st.markdown(f"### {method_label}")

    # --- Top anomalies: select a row to highlight on the plot ---
    highlight_pos = None
    if show_top > 0:
        cols_keep = [
            "Test_Run_ID", "FR", "Num_Tests", "total_init_time",
            "anomaly_score", "raw_anomaly_score",
            "Simulation_Host", "Simulation_Node", "Capability",
            "Script_File", "V", "s_number", "Build"
        ]
        cols_keep = [c for c in cols_keep if c in df.columns]

        top = df.sort_values("anomaly_score", ascending=False).head(show_top)

        st.markdown("**Top anomalies**")
        editable = top[cols_keep].copy()
        editable.insert(0, "Select", False)

        edited = st.data_editor(
            editable,
            use_container_width=True,
            num_rows="fixed",
            disabled={c: True for c in editable.columns if c != "Select"},
            key=f"{key_prefix}-table"
        )

        selected_original_idxs = edited.index[edited["Select"]].tolist()
        if selected_original_idxs:
            pos = df.index.get_indexer([selected_original_idxs[0]])
            if len(pos) and pos[0] != -1:
                highlight_pos = int(pos[0])

    # --- PCA plot with optional highlight ---
    fig = plot_for_df(df, PCs, label_choice, highlight_pos=highlight_pos)

    # === Driver arrows overlays ===
    if show_biplot and PCs.shape[1] >= 2 and pca is not None:
        # 1) Global arrows from origin (intentional: show global directions)
        try:
            add_pca_loadings_3d(fig, pca, FEATURES_FOR_ANALYSIS, scale=2.0)
        except Exception:
            pass

        # 2) Segment-anchored arrows near each band (Low FR = green, High FR = red)
        try:
            seg = make_fr_segments(df)  # "Low FR" / "Mid FR" / "High FR"
            # Low-FR centroid
            low_mask = (seg == "Low FR").values
            if np.any(low_mask):
                low_anchor = PCs[low_mask].mean(axis=0)
                add_biplot_arrows_at_anchor_3d(
                    fig, pca, FEATURES_FOR_ANALYSIS, low_anchor,
                    scale=1.2, color="green", name_prefix="Low FR ", showlegend=False
                )
            # High-FR centroid
            high_mask = (seg == "High FR").values
            if np.any(high_mask):
                high_anchor = PCs[high_mask].mean(axis=0)
                add_biplot_arrows_at_anchor_3d(
                    fig, pca, FEATURES_FOR_ANALYSIS, high_anchor,
                    scale=1.2, color="red", name_prefix="High FR ", showlegend=False
                )
        except Exception:
            pass

    st.plotly_chart(fig, use_container_width=True, key=f"{key_prefix}-plot")

    # --- Segment Comparison + FR Correlation ---
    if show_segment_compare:
        c1, c2 = st.columns([2, 1])
        with c1:
            st.markdown("#### Segment Comparison: Low vs High FR")
            st.plotly_chart(
                segment_diff_bar(df),
                use_container_width=True,
                key=f"{key_prefix}-segdiff"
            )
        with c2:
            st.markdown("#### FR Correlation")
            st.plotly_chart(
                fr_correlation_heatmap(df),
                use_container_width=True,
                key=f"{key_prefix}-frcorr"
            )

    # --- Per-selection “Why this run?” ---
    if show_selection_why and highlight_pos is not None:
        st.markdown("#### Why this run?")
        st.plotly_chart(
            per_point_contribution_bar(df, highlight_pos),
            use_container_width=True,
            key=f"{key_prefix}-whybar"
        )



=========================================================================================================================================================================
=========================================================================================================================================================================

=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================


