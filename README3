# === VISUAL ANALYTICS HELPERS ===
import plotly.graph_objects as go
import numpy as np
import pandas as pd

FEATURES_FOR_ANALYSIS = ["P","F","B","U","total_init_time","FR","Num_Tests"]

def zscore_frame(df: pd.DataFrame, cols: list[str]) -> pd.DataFrame:
    z = df[cols].astype(float)
    mu = z.mean(axis=0)
    sd = z.std(axis=0).replace(0, 1.0)
    return (z - mu) / sd

def make_fr_segments(df: pd.DataFrame) -> pd.Series:
    # Low / Mid / High by FR quartiles (emphasize extremes)
    q25, q75 = df["FR"].quantile([0.25, 0.75])
    seg = pd.Series(np.where(df["FR"] >= q75, "High FR",
                     np.where(df["FR"] <= q25, "Low FR", "Mid FR")),
                    index=df.index, name="FR_Segment")
    return seg

def segment_diff_bar(df: pd.DataFrame) -> go.Figure:
    # Compare Low vs High in normalized space
    seg = make_fr_segments(df)
    z = zscore_frame(df, FEATURES_FOR_ANALYSIS)
    low = z[seg == "Low FR"].mean()
    high = z[seg == "High FR"].mean()
    diff = (high - low).sort_values(key=lambda s: s.abs(), ascending=False)

    fig = go.Figure()
    fig.add_bar(x=diff.index, y=diff.values)
    fig.update_layout(
        title="Feature Difference (High FR − Low FR) [z-score]",
        xaxis_title="Feature",
        yaxis_title="Δ z-score (higher ⇒ higher in High-FR segment)",
        height=360, margin=dict(l=10, r=10, t=40, b=60)
    )
    return fig

def fr_correlation_heatmap(df: pd.DataFrame) -> go.Figure:
    cols = FEATURES_FOR_ANALYSIS
    corr = df[cols + ["FR"]].corr().loc[cols, ["FR"]].round(3)
    fig = go.Figure(data=go.Heatmap(
        z=corr.values.T, x=cols, y=["FR"], text=corr.values.T, texttemplate="%{text}",
        zmin=-1, zmax=1, colorbar=dict(title="corr")
    ))
    fig.update_layout(title="Correlation with FR", height=220, margin=dict(l=10, r=10, t=40, b=10))
    return fig

def add_pca_loadings_3d(fig: go.Figure, pca, feature_names: list[str], scale: float = 2.0):
    """
    Overlay PCA loading arrows (components) for first 3 PCs.
    """
    loadings = pca.components_.T  # shape: (n_features, n_components)
    k = min(3, loadings.shape[1])
    for i, fname in enumerate(feature_names):
        vec = loadings[i, :k] * scale
        if k == 3:
            x, y, z = [0, vec[0]], [0, vec[1]], [0, vec[2]]
            fig.add_trace(go.Scatter3d(x=x, y=y, z=z, mode="lines",
                                       line=dict(width=5), name=f"→ {fname}", showlegend=False))
            # text label at arrow tip
            fig.add_trace(go.Scatter3d(x=[vec[0]], y=[vec[1]], z=[vec[2]],
                                       mode="text", text=[fname], showlegend=False))
        elif k == 2:
            # Fallback 2D
            x, y = [0, vec[0]], [0, vec[1]]
            fig.add_trace(go.Scatter(x=x, y=y, mode="lines+text",
                                     text=[None, fname], textposition="top center", showlegend=False))
    return fig

def per_point_contribution_bar(df: pd.DataFrame, row_pos: int) -> go.Figure:
    """
    Show top-5 z-score deviations for a selected point (why it's weird).
    """
    z = zscore_frame(df, FEATURES_FOR_ANALYSIS)
    if row_pos < 0 or row_pos >= len(z):
        row_pos = 0
    row = z.iloc[row_pos].abs().sort_values(ascending=False).head(5)
    # Use signed values for direction
    signed = z.iloc[row_pos][row.index]
    fig = go.Figure(go.Bar(x=signed.index, y=signed.values))
    fig.update_layout(
        title="Why this run? Top deviations (z-scores)",
        xaxis_title="Feature",
        yaxis_title="Deviation (±σ)",
        height=300, margin=dict(l=10, r=10, t=40, b=40)
    )
    return fig



=========================================================================================================================================================================
=========================================================================================================================================================================

# === Visual analytics toggles ===
st.sidebar.subheader("Root-Cause Visuals")
show_biplot = st.sidebar.checkbox("Show PCA driver arrows (feature loadings)", value=True)
show_segment_compare = st.sidebar.checkbox("Show Low-vs-High FR compare", value=True)
show_selection_why = st.sidebar.checkbox("Show 'Why this run?' panel", value=True)




=========================================================================================================================================================================
=========================================================================================================================================================================

# BEFORE you had:
# _, _, _, PCs = fit_pca_scaled(X, n_components=3)

scaler, pca, Xz_unused, PCs = fit_pca_scaled(X, n_components=3)

=========================================================================================================================================================================
=========================================================================================================================================================================

fig = plot_for_df(df, PCs, label_choice, highlight_pos=highlight_pos)

# NEW: overlay PCA driver arrows (biplot) for first 3 PCs
if show_biplot and PCs.shape[1] >= 2:
    try:
        add_pca_loadings_3d(fig, pca, FEATURES_FOR_ANALYSIS, scale=2.0)
    except Exception:
        pass

st.plotly_chart(fig, use_container_width=True, key=f"{path.name}-rootplot")


=========================================================================================================================================================================
=========================================================================================================================================================================

# NEW: Segment Compare & Correlation
if show_segment_compare:
    c1, c2 = st.columns([2, 1])
    with c1:
        st.markdown("#### Segment Comparison: Low vs High FR")
        st.plotly_chart(segment_diff_bar(df), use_container_width=True, key=f"{path.name}-segdiff")
    with c2:
        st.markdown("#### FR Correlation")
        st.plotly_chart(fr_correlation_heatmap(df), use_container_width=True, key=f"{path.name}-frcorr")


=========================================================================================================================================================================
=========================================================================================================================================================================

# NEW: Per-selection "Why" panel (uses the row selected in Top anomalies)
if show_selection_why and highlight_pos is not None:
    st.markdown("#### Why this run?")
    st.plotly_chart(per_point_contribution_bar(df, highlight_pos),
                    use_container_width=True, key=f"{path.name}-whybar")

=========================================================================================================================================================================
=========================================================================================================================================================================


=========================================================================================================================================================================
=========================================================================================================================================================================
