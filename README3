# NEW: helper to build a contribution bar chart for a selected point
def feature_contrib_plot(xz_row: np.ndarray, feature_names: list[str], top_k: int = 8) -> go.Figure:
    # importance = squared z-score (bigger => more responsible for anomaly)
    z = xz_row.astype(float)
    imp = z ** 2
    dir_sign = np.sign(z)  # +1 / -1

    contrib = pd.DataFrame({
        "feature": feature_names,
        "importance": imp,
        "z": z,
        "direction": np.where(dir_sign >= 0, "↑", "↓"),
    })

    # keep top_k most important features
    contrib = contrib.sort_values("importance", ascending=False).head(top_k)
    contrib = contrib.sort_values("importance", ascending=True)  # small->large for nicer horizontal bars

    # bar figure
    fig = go.Figure(go.Bar(
        x=contrib["importance"],
        y=contrib["feature"],
        orientation="h",
        text=[f'{d}{abs(val):.2f}σ' for d, val in zip(contrib["direction"], contrib["z"])],
        textposition="outside"
    ))
    fig.update_layout(
        title="Why this point looks odd",
        xaxis_title="Importance (squared z-score)",
        yaxis_title="Feature",
        margin=dict(l=10, r=10, t=40, b=10),
        height=420
    )
    return fig


=========================================================================================================================================================================
=========================================================================================================================================================================

# MODIFIED: keep scaler outputs and standardized matrix from fit_pca_scaled
scaler, pca, Xz, PCs = fit_pca_scaled(X.to_numpy(), n_components=3)


=========================================================================================================================================================================
=========================================================================================================================================================================

# MODIFIED: render_one() – create a two-column layout and render contributions for the selected point
st.subheader(path.name)

# ---------- Top anomalies (user selection drives highlight & contributions) ----------
highlight_pos = None
if show_top > 0:
    cols_keep = ["Test_Run_ID","FR","Num_Tests","total_init_time","anomaly_score",
                 "Simulation_Host","Simulation_Node","Capability","Script_File","V","s_number","Build"]
    cols_keep = [c for c in cols_keep if c in df.columns]

    top = df.sort_values("anomaly_score", ascending=False).head(show_top)
    st.markdown("**Top anomalies**")

    editable = top[cols_keep].copy()
    editable.insert(0, "Select", False)

    edited = st.data_editor(
        editable,
        use_container_width=True,
        num_rows="fixed",
        disabled={c: True for c in editable.columns if c != "Select"}
    )

    # Map the first selected row back to the original df row position
    selected_original_idxs = edited.index[edited["Select"]].tolist()
    if selected_original_idxs:
        pos = df.index.get_indexer([selected_original_idxs[0]])
        if len(pos) and pos[0] != -1:
            highlight_pos = int(pos[0])

# ---------- LAYOUT: plot (left) and contributions (right) ----------
left, right = st.columns([3, 2], vertical_alignment="top")

with left:
    fig = plot_for_df(df, PCs, label_choice, highlight_pos=highlight_pos)
    st.plotly_chart(fig, use_container_width=True)

with right:
    st.markdown("### Root-cause cues")
    if highlight_pos is None:
        # default to the top anomaly if nothing selected
        default_idx = int(df["anomaly_score"].values.argmax())
        xz_row = Xz[default_idx]
        st.caption("Showing top-ranked anomaly (select a row in the table to update)")
    else:
        xz_row = Xz[highlight_pos]

    contrib_fig = feature_contrib_plot(xz_row, feature_names=list(X.columns), top_k=8)
    st.plotly_chart(contrib_fig, use_container_width=True)

    # Optional quick-glance badges
    top_feats = (np.abs(xz_row)).argsort()[::-1][:3]
    badges = ", ".join([list(X.columns)[i] for i in top_feats])
    st.write(f"**Most unusual features:** {badges}")

=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================


=========================================================================================================================================================================
=========================================================================================================================================================================


=========================================================================================================================================================================
=========================================================================================================================================================================


=========================================================================================================================================================================
=========================================================================================================================================================================
