def segment_diff_bar(df: pd.DataFrame) -> go.Figure:
    """
    Compare Low-FR vs High-FR segments for each feature in FEATURES_FOR_ANALYSIS.

    - For numeric features: show mean z-score difference (High − Low).
    - For categorical features: show % difference (High − Low)
      of how often each category value appears within its FR segment.
    - Keeps the top-5 absolute differences overall.
    """
    fig = go.Figure()
    seg = make_fr_segments(df)
    if "FR" not in df.columns or seg is None:
        fig.update_layout(title="Segment Comparison (FR data unavailable)")
        return fig

    # Separate low and high FR subsets
    low_df = df[seg == "Low FR"]
    high_df = df[seg == "High FR"]

    numeric_diffs = {}
    categorical_diffs = {}

    for feat in FEATURES_FOR_ANALYSIS:
        if feat not in df.columns:
            continue
        s = df[feat]

        # Numeric: use standardized mean difference
        if np.issubdtype(s.dtype, np.number):
            z = (s - s.mean()) / s.std(ddof=0) if s.std(ddof=0) != 0 else s * 0
            diff = z[high_df.index].mean() - z[low_df.index].mean()
            numeric_diffs[feat] = diff
        else:
            # Categorical: compute percentage of each value in each FR segment
            high_pct = high_df[feat].value_counts(normalize=True)
            low_pct = low_df[feat].value_counts(normalize=True)
            # Align all possible categories
            all_values = set(high_pct.index) | set(low_pct.index)
            for val in all_values:
                diff = high_pct.get(val, 0) - low_pct.get(val, 0)
                categorical_diffs[f"{feat}={val}"] = diff

    # Combine and select top-5 absolute differences
    all_diffs = {**numeric_diffs, **categorical_diffs}
    if not all_diffs:
        fig.update_layout(
            title="No valid features in FEATURES_FOR_ANALYSIS",
            height=250,
            margin=dict(l=10, r=10, t=40, b=40),
        )
        return fig

    top5 = dict(sorted(all_diffs.items(), key=lambda kv: abs(kv[1]), reverse=True)[:5])

    fig.add_bar(x=list(top5.keys()), y=list(top5.values()))
    fig.update_layout(
        title="Top-5 Drivers of Failure Rate (High FR − Low FR)",
        xaxis_title="Feature / Value",
        yaxis_title="Δ (z-score or % share)",
        height=380,
        margin=dict(l=10, r=10, t=40, b=80),
    )
    return fig





=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================


=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================




=========================================================================================================================================================================
=========================================================================================================================================================================



=========================================================================================================================================================================
=========================================================================================================================================================================


